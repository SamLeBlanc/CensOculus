<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>SNAPSHOT</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.js"></script>
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script type="text/javascript" src="scripts/dataLoadingAndManipulation.js"></script>
  <script type="text/javascript" src="scripts/addSourcesAndLayers.js"></script>
  <script type="text/javascript" src ="scripts/draggable.js"></script>
  <script type="text/javascript" src="scripts/DICTIONARIES.js"></script>
  <script type="text/javascript" src="scripts/INTRO.js"></script>
  <script type="text/javascript" src="scripts/snapshotHoverStates.js"></script>
  <script type="text/javascript" src="scripts/customRanges.js"></script>
  <script type="text/javascript" src="scripts/featureStatus.js"></script>
  <script type="text/javascript" src="scripts/numberFormats.js"></script>
  <script type="text/javascript" src="scripts/coloring.js"></script>
  <script type="text/javascript" src="scripts/main.js"></script>
  <link rel="stylesheet" href="styles/styles.css">
  <link rel="stylesheet" href="styles/draggable.css">
</head>
<body>

  <div id="map"></div>
  <div id="move" style="z-index:50"></div>
  <div id="T">
    <table class="tableB" id="tabeleta">
      <tr>
        <td>Geography</td>
        <td>
          <div id="geo-select" onclick="update()">
            <select style="width:199px;">
              <option value="nation">Nation</option>
              <option value="state">State</option>
              <option value="county">County</option>
              <option value="tract">Tract</option>
              <option value="group">Group</option>
              <option value="metroSA">Metro Stat Area</option>
              <option value="urban">Urban Areas</option>
              <option value="zip">Zip Codes</option>
            </select>
          </div>
        </td>
      </tr>
      <tr>
        <td>Concept</td>
        <td>
          <div id="concept-select" onclick="updateConcept()">
            <select style="width:199px;">
              <option value="P1">[P1] TOTAL POPULATION </option>
              <option value="P2">[P2] URBAN AND RURAL</option>
              <option value="P3">[P3] RACE</option>
              <option value="P4">[P4] HISPANIC OR LATINO ORIGIN</option>
              <option value="P5">[P5] HISPANIC OR LATINO ORIGIN BY RACE</option>
              <option value="P6">[P6] RACE (TOTAL RACES TALLIED)</option>
              <option value="P7">[P7] HISPANIC OR LATINO ORIGIN BY RACE (TOTAL RACES TALLIED)</option>
              <option value="P8">[P8] RACE</option>
              <option value="P9">[P9] HISPANIC OR LATINO, AND NOT HISPANIC OR LATINO BY RACE</option>
              <option value="P10">[P10] RACE FOR THE POPULATION 18 YEARS AND OVER</option>
              </select>
          </div>
        </td>
      </tr>
      <tr>
        <td>Variable</td>
        <td>
          <div id="variable-select" onclick="update()">
            <select id="SS" style="width:199px;">
            </select>
        </div>
      </td>
      </tr>
      <tr>
        <td>Scale</td>
        <td>
          <div id="scale-select">
            <select style="width:199px;">
              <option value="Linear" onclick="update()">Linear</option>
              <option value="Quantile" onclick="update()">Quantile</option>
              <option value="Custom Linear" onclick="customL()">Custom Linear</option>
              <option value="Custom Quantile" onclick="customQ()">Custom Quantile</option>
            </select>
          </div>
        </td>
      </tr>
      <tr>
        <td>Color</td>
        <td>
          <div id="color-select" onclick="customColors=[null,null,null,null,null]; update()">
            <select style="width:199px;">
              <option value="Viridis">Viridis</option>
              <option value="Red">Red</option>
              <option value="Blue">Blue</option>
              <option value="Green">Green</option>
              <option value="Purple">Purple</option>
              <option value="Black">Black</option>
              <option value="Rainbow">Rainbow</option>
              <option value="Viridis Light">Viridis Light</option>
              <option value="Greyscale">Greyscale</option>
              <option value="Heat">Heat</option>
              <option value="Magma">Magma</option>
              <option value="Brown-Teal">Brown-Teal</option>
              <option value="Blue-Red">Blue-Red</option>
            </select>
          </div>
        </td>
      </tr>
      <tr>
        <td>Num Format&nbsp&nbsp</td>
        <td>
          <div id="numformat-select" onclick="update()">
            <select style="width:199px;">
              <option value="short">Short</option>
              <option value="comma">Commas</option>
            </select>
          </div>
        </td>
      </tr>
    </table>
    <div><button type="button" onclick="console.log('update'); update()" style="background-color: lightgreen; z-index:11; ">Update</button></div>
  </div>
  <div id="legend">
    <div id="sqaures">
      <div style="padding:3px;">
        <div id='cwrap-0' class="color-picker-wrapper"><input type="color" value="transparent" id="cpick-0"></div>
        <div id="leg-square-0" class="legend-square" style="background:red;"></div>
      </div>
      <div style="padding:3px;">
        <div id='cwrap-1' class="color-picker-wrapper"><input type="color" value="transparent" id="cpick-1"></div>
        <div id="leg-square-1" class="legend-square" style="background:orange;"></div>
      </div>
      <div style="padding:3px;">
        <div id='cwrap-2' class="color-picker-wrapper"><input type="color" value="transparent" id="cpick-2"></div>
        <div id="leg-square-2" class="legend-square" style="background:yellow;"></div>
      </div>
      <div style="padding:3px;">
        <div id='cwrap-3' class="color-picker-wrapper"><input type="color" value="transparent" id="cpick-3"></div>
        <div id="leg-square-3" class="legend-square" style="background:green;"></div>
      </div>
      <div style="padding:3px;">
        <div id='cwrap-4' class="color-picker-wrapper"><input type="color" value="transparent" id="cpick-4"></div>
        <div id="leg-square-4" class="legend-square" style="background:blue;"></div>
      </div>
    </div>
    <div id="labels" ondblclick="getCustomRange();" style="padding-top:13px; position:absolute; top:0px; left:60px;">
      <div class="legend-label" ><span onclick="customQ" id='leg-label-0'>1</span></div>
      <div class="legend-label" ><span id='leg-label-1'>2</span></div>
      <div class="legend-label" ><span id='leg-label-2'>3</span></div>
      <div class="legend-label" ><span id='leg-label-3'>4</span></div>
      <div class="legend-label" ><span id='leg-label-4'>5</span></div>
    </div>
  </div>
  <div id="intro">
    <div>
      <span id = "intro-title"></span>
    </div>
    <br>
    <div style="width:480px; padding: 5px; border-radius: 10px;">
      <span id = "intro-text" style="font-weight:bold;"></span>
      <button id="next-1" class="next-button" style="opacity: 0" onclick="holder()">âžœ</button>
    </div>
  </div>
  <div id="current-view">
    <span style="font-size:20px;">Current Map View:<br></span>
    <span id="cur-view" style="font-size:15px;">May 12 10:16am</span>
  </div>
<script>
yeet()

var CONCEPT = "P6"

function updateConcept(){
  CONCEPT = $('#concept-select').find(":selected").val();
  createSelect2("SS",VARIABLE_LIST_BY_CONCEPT[CONCEPT])
  update()

}

function yeet(){
  $('#cpick-0').on('change', function() { addCustomColor(0) });
  $('#cpick-1').on('change', function() { addCustomColor(1) });
  $('#cpick-2').on('change', function() { addCustomColor(2) });
  $('#cpick-3').on('change', function() { addCustomColor(3) });
  $('#cpick-4').on('change', function() { addCustomColor(4) });
}

  var QUARTILE_RANGE = [0, 0.25, 0.5, 0.75, 1];
  var LINEAR_RANGE = [-69.42,69.42];
  var customColors = [null, null, null, null, null]
  $(document).on('mousemove', function(e){
    $('#move').css({
      left:  e.pageX+10,
      top:   e.pageY+10
    });
  });

function addCustomColor(i){
  customColors[i] = $('#cpick-'.concat(i)).val()
  update()
}

function getCustomRange(){
  s = $('#scale-select').find(":selected").val();
  if (s.includes('Linear')) customL();
  else if (s.includes('Quantile')) customQ();
}

function createSelect2(id,list) {
  var x = document.getElementById(id);
  var length = x.length;
  for (i = length-1; i >= 0; i--) {
    x.options[i] = null;
  }
  for (const item of list) {
    var z = document.createElement("option");
    z.setAttribute("value", item);
    var t = document.createTextNode(item);
    z.appendChild(t);
    x.appendChild(z);
  }
  update()
}

  function updateGeo(){
    v = $('#geo-select').find(":selected").val();
    hideAllLayers()
    map.setLayoutProperty(v.concat('-fills'),'visibility','visible')
    map.setLayoutProperty(v.concat('-lines'),'visibility','visible')
  }

function dataByGroup(){
  if (CONCEPT == 'P1') return P1
  if (CONCEPT == 'P2') return P2
  if (CONCEPT == 'P3') return P3
  if (CONCEPT == 'P4') return P4
  if (CONCEPT == 'P5') return P5
  if (CONCEPT == 'P6') return P6
  if (CONCEPT == 'P7') return P7
  if (CONCEPT == 'P8') return P8
  if (CONCEPT == 'P9') return P9
  if (CONCEPT == 'P10') return P10
}

function getQuantileValues(variable, geo){
  doot = dataByGroup().filter(function(d){ return d["SIZE"] == geo.toUpperCase() })
  if (!variable.endsWith('P')){
    datBoi = doot.map(function(d) { return d[variable] })
  }
  else {
    var cat = variable.slice(0,-1);
    var cat_total = variable.slice(0,4).concat("001");
    datBoi = doot.map(function(d) { return (d[cat] / (1 + d[PERCENT_DICT[cat]])) })
  }
  datBoi = datBoi.sort(function(a, b){return a - b});

  var scale = $('#scale-select').find(":selected").val();
  if (scale == 'Quantile'){
    QUARTILE_RANGE = [0, 0.25, 0.5, 0.75, 1]
  }
  var quants = [];
  QUARTILE_RANGE.forEach((q) => {
    quants.push(d3.quantile(datBoi, q));
  });
  return quants
}

function updateVariable(){
  variable = $('#variable-select').find(":selected").val();
  setFeatStates(variable)
  geo = $('#geo-select').find(":selected").val();
  var quants = getQuantileValues(variable, geo)
  hover([variable],geo);
  layer_name = geo.concat('-fills')
  colorLayer(layer_name, variable, quants)
}

function update(){
  updateGeo()
  updateVariable()
}

function featureQuery(){
  var geo = $('#geo-select').find(":selected").val();
  var source = SOURCE_DICT[geo]
  F = map.queryRenderedFeatures()
  G = []
  H = []
  F.forEach((element) => {
    if(element.source == source && !H.includes(element.id)){
      G.push(element)
      H.push(element.id)
    }
  });
}


mapboxgl.accessToken = 'pk.eyJ1Ijoic2FtbGVibGFuYyIsImEiOiJja2hneXNrOXUxOWdyMnF0OWgxdWRma3VsIn0.NClhc-lMIVbihpDxZ12YuQ';
var map = new mapboxgl.Map({
  container: 'map', // container id
  style: 'mapbox://styles/mapbox/light-v10', // style URL
  center: [-104.800644, 38.846127],
  zoom: 3.6,
  pitch: 0,
  interactive: true,
});
//map.scrollZoom.disable();

var hoveredStateId = null;

map.on('load', function () {
  addSources()
  addNativelandLayers()
  addNationLayers()
  addStateLayers()
  addCountyLayers()
  addTractLayers()
  addGroupLayers()
  addMetroSALayers()
  addUrbanLayers()
  addZipLayers()
  console.log('Layers loaded')

  var DATA = [];
  var DATA1 = [];
  var P1 = [];
  var P2 = [];
  var P3 = [];
  var P4 = [];
  var P5 = [];
  var P6 = [];
  var P7 = [];
  var P8 = [];
  var P9 = [];
  var P10 = [];
  loadDataFromCSV()

  //update()




});
</script>
</body>
</html>
